<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Staff Rotas Data</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .data {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        white-space: pre-wrap;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .danger {
        background: #dc3545;
      }
      .danger:hover {
        background: #c82333;
      }
    </style>
  </head>
  <body>
    <h1>Staff Rotas Data Debug</h1>

    <div class="section">
      <h2>Current Data Status</h2>
      <button onclick="checkData()">Check Data</button>
      <button onclick="showAssignments()">Show Assignments</button>
      <div id="status"></div>
    </div>

    <div class="section">
      <h2>Data Management</h2>
      <button onclick="reinitializeData()" class="danger">Reinitialize All Data</button>
      <button onclick="reinitializeAssignments()">Reinitialize Assignments Only</button>
      <button onclick="autoAssignPorters()">Create Test Assignments</button>
      <button onclick="clearData()" class="danger">Clear All Data</button>
      <button onclick="testDailyAssignments()">Test Daily Assignments</button>
      <button onclick="debugPorterData()">Debug Porter Data</button>
      <button onclick="debugAssignments()">Debug Assignments</button>
      <button onclick="debugDepartments()">Debug Departments</button>
      <div id="management-status"></div>
    </div>

    <div class="section">
      <h2>Raw Data</h2>
      <button onclick="showRawData()">Show Raw Data</button>
      <div id="raw-data" class="data"></div>
    </div>

    <script>
      function checkData() {
        const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')
        const status = document.getElementById('status')

        status.innerHTML = `
                <h3>Data Summary:</h3>
                <p><strong>Porters:</strong> ${data.porters?.length || 0}</p>
                <p><strong>Departments:</strong> ${data.departments?.length || 0}</p>
                <p><strong>Assignments:</strong> ${data.assignments?.length || 0}</p>
                <p><strong>Absences:</strong> ${data.absences?.length || 0}</p>
            `
      }

      function showAssignments() {
        const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')
        const status = document.getElementById('status')

        if (data.assignments && data.assignments.length > 0) {
          const assignmentDetails = data.assignments.map((a) => {
            const porter = data.porters?.find((p) => p.id === a.porter_id)
            const department = data.departments?.find((d) => d.id === a.department_id)
            return {
              porter: porter?.name || `Porter ID ${a.porter_id}`,
              department: department?.name || `Dept ID ${a.department_id}`,
              permanent: a.is_permanent,
            }
          })

          status.innerHTML += `
                    <h3>Assignment Details:</h3>
                    <div class="data">${JSON.stringify(assignmentDetails, null, 2)}</div>
                `
        } else {
          status.innerHTML += '<p><strong>No assignments found!</strong></p>'
        }
      }

      function showRawData() {
        const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')
        document.getElementById('raw-data').textContent = JSON.stringify(data, null, 2)
      }

      function clearData() {
        if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
          localStorage.removeItem('staff-rotas-data')
          document.getElementById('management-status').innerHTML =
            '<p style="color: red;">All data cleared!</p>'
        }
      }

      function reinitializeAssignments() {
        if (
          confirm(
            'Are you sure you want to reinitialize assignments? This will clear existing assignments and create fresh ones.',
          )
        ) {
          const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')
          if (data.assignments) {
            data.assignments = []
            localStorage.setItem('staff-rotas-data', JSON.stringify(data, null, 2))
          }
          document.getElementById('management-status').innerHTML =
            '<p style="color: green;">Assignments cleared. Please refresh the main application to reinitialize.</p>'
        }
      }

      function reinitializeData() {
        if (
          confirm(
            'Are you sure you want to reinitialize all data? This will clear existing data and create fresh seed data.',
          )
        ) {
          localStorage.removeItem('staff-rotas-data')
          document.getElementById('management-status').innerHTML =
            '<p style="color: green;">Data cleared. Please refresh the main application to reinitialize.</p>'
        }
      }

      function autoAssignPorters() {
        if (
          confirm(
            'Create simple test assignments? This will assign a few porters to Day Shift A for testing.',
          )
        ) {
          const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')

          // Ensure data structure exists
          if (!data.assignments) data.assignments = []
          if (!data.nextAssignmentId) data.nextAssignmentId = 1

          // Clear existing assignments
          data.assignments = []

          // Find Day Shift A department (should be ID 1)
          const dayShiftAId = 1

          // Find some Day Shift One porters (should be IDs 1-20)
          const porterIds = [1, 2, 3, 4, 5] // First 5 porters

          // Create simple assignments
          porterIds.forEach((porterId) => {
            data.assignments.push({
              id: data.nextAssignmentId++,
              porter_id: porterId,
              department_id: dayShiftAId,
              is_permanent: true,
              start_date: new Date().toISOString().split('T')[0],
              created_at: new Date().toISOString(),
            })
          })

          localStorage.setItem('staff-rotas-data', JSON.stringify(data, null, 2))
          document.getElementById('management-status').innerHTML =
            `<p style="color: green;">Created ${porterIds.length} test assignments. Refresh the main application to see results.</p>`
        }
      }

      function testDailyAssignments() {
        const today = new Date().toISOString().split('T')[0]
        console.log('Testing daily assignments for:', today)

        // This would need to be called from the main app context
        const status = document.getElementById('status')
        status.innerHTML += `
          <h3>Daily Assignments Test:</h3>
          <p>Open browser console and check for debug messages when viewing the shift screen.</p>
          <p>Today's date: ${today}</p>
          <p>Look for messages starting with üîç, üìã, üîß, ‚úÖ</p>
        `
      }

      function debugPorterData() {
        const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')

        console.log('üîç PORTER DATA DEBUG:')
        console.log('Total porters:', data.porters?.length || 0)

        // Group porters by type
        const byType = {}
        const byShiftGroup = {}

        data.porters?.forEach((porter) => {
          // Group by type
          if (!byType[porter.type]) byType[porter.type] = []
          byType[porter.type].push(porter.name)

          // Group by shift group
          const shiftGroup = porter.shift_group || 'No Shift Group'
          if (!byShiftGroup[shiftGroup]) byShiftGroup[shiftGroup] = []
          byShiftGroup[shiftGroup].push(porter.name)
        })

        console.log('üìä By Porter Type:', byType)
        console.log('üìä By Shift Group:', byShiftGroup)

        // Check Relief specifically
        const reliefTypePorters = data.porters?.filter((p) => p.type === 'Relief') || []
        const reliefShiftPorters = data.porters?.filter((p) => p.shift_group === 'Relief') || []

        console.log(
          'üö® Relief Type Porters:',
          reliefTypePorters.length,
          reliefTypePorters.map((p) => p.name),
        )
        console.log(
          'üö® Relief Shift Group Porters:',
          reliefShiftPorters.length,
          reliefShiftPorters.map((p) => p.name),
        )

        document.getElementById('management-status').innerHTML =
          `<pre>Relief Type: ${reliefTypePorters.length} porters\nRelief Shift Group: ${reliefShiftPorters.length} porters\nSee console for details</pre>`
      }

      function debugAssignments() {
        const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')

        console.log('üîç ASSIGNMENT DEBUG:')
        console.log('Total assignments:', data.assignments?.length || 0)

        // Group assignments by department
        const byDepartment = {}

        data.assignments?.forEach((assignment) => {
          const deptId = assignment.department_id
          if (!byDepartment[deptId]) byDepartment[deptId] = []
          byDepartment[deptId].push({
            porter_id: assignment.porter_id,
            is_permanent: assignment.is_permanent,
            start_date: assignment.start_date,
          })
        })

        console.log('üìä Assignments by Department ID:', byDepartment)

        // Find Ad-Hoc department
        const adHocDept = data.departments?.find((d) => d.name === 'Ad-Hoc')
        if (adHocDept) {
          const adHocAssignments =
            data.assignments?.filter((a) => a.department_id === adHocDept.id) || []
          console.log(
            `üéØ Ad-Hoc Department (ID: ${adHocDept.id}) has ${adHocAssignments.length} assignments:`,
          )
          adHocAssignments.forEach((a) => {
            const porter = data.porters?.find((p) => p.id === a.porter_id)
            console.log(`  - Porter: ${porter?.name || 'Unknown'} (ID: ${a.porter_id})`)
          })
        } else {
          console.log('‚ùå Ad-Hoc department not found!')
        }

        document.getElementById('management-status').innerHTML =
          `<pre>Total assignments: ${data.assignments?.length || 0}\nAd-Hoc assignments: ${adHocDept ? (data.assignments?.filter((a) => a.department_id === adHocDept.id) || []).length : 'N/A'}\nSee console for details</pre>`
      }

      function debugDepartments() {
        const data = JSON.parse(localStorage.getItem('staff-rotas-data') || '{}')

        console.log('üè¢ DEPARTMENT DEBUG:')
        console.log('Total departments:', data.departments?.length || 0)

        if (data.departments) {
          console.log('üìã All departments:')
          data.departments.forEach((dept) => {
            console.log(`  - ${dept.name} (ID: ${dept.id})`)
          })

          // Look for Ad-Hoc specifically
          const adHocDept = data.departments.find((d) => d.name === 'Ad-Hoc')
          if (adHocDept) {
            console.log(`üéØ Ad-Hoc Department found:`, adHocDept)
          } else {
            console.log('‚ùå Ad-Hoc Department NOT FOUND!')

            // Look for similar names
            const similarDepts = data.departments.filter(
              (d) =>
                d.name.toLowerCase().includes('ad') ||
                d.name.toLowerCase().includes('hoc') ||
                d.name.toLowerCase().includes('adhoc'),
            )
            if (similarDepts.length > 0) {
              console.log('üîç Similar department names found:', similarDepts)
            }
          }
        }

        document.getElementById('management-status').innerHTML =
          `<pre>Total departments: ${data.departments?.length || 0}\nAd-Hoc found: ${data.departments?.find((d) => d.name === 'Ad-Hoc') ? 'YES' : 'NO'}\nSee console for details</pre>`
      }

      // Auto-check data on load
      window.onload = checkData
    </script>
  </body>
</html>
